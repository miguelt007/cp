<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Comboios em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    .leaflet-control.legenda {
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
    }

    .legenda-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .legenda-bola {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([39.5, -8.0], 7);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const legenda = L.control({ position: 'topright' });

    legenda.onAdd = function () {
      const div = L.DomUtil.create('div', 'leaflet-control legenda');
      div.innerHTML = `
        <div class="legenda-item"><div class="legenda-bola" style="background:#00ff00"></div> ALFA PENDULAR</div>
        <div class="legenda-item"><div class="legenda-bola" style="background:#4CAF50"></div> INTERCIDADES</div>
        <div class="legenda-item"><div class="legenda-bola" style="background:#2196F3"></div> REGIONAIS</div>
        <div class="legenda-item"><div class="legenda-bola" style="background:#212df3"></div> InterRegionais</div>
        <div class="legenda-item"><div class="legenda-bola" style="background:#FFEB3B"></div> Urbanos</div>
        <div class="legenda-item"><div class="legenda-bola" style="background:#B0BEC5"></div> Outros</div>
      `;
      return div;
    };

    legenda.addTo(map);

    let markers = [];

    function criarIcone(corHex) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
          <circle cx="12" cy="12" r="8" fill="${corHex}" stroke="white" stroke-width="1"/>
        </svg>
      `;
      return L.icon({
        iconUrl: "data:image/svg+xml;base64," + btoa(svg),
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    const cores = {
      "alfa pendular": "#00ff00",
      "intercidades": "#4CAF50",
      "regionais": "#2196F3",
      "interregionais": "#212df3",
      "urbanos": "#FFEB3B",
      "urbanos lisboa": "#FFEB3B",
      "urbanos porto": "#FFEB3B",
      "default": "#B0BEC5"
    };

    const estadosLegiveis = {
  "AT_ORIGIN": (train) => `Na estação de origem: ${train.origin?.designation || '---'}`,
  "IN_TRANSIT": () => "Em viagem",
  "AT_STATION": (train) => {
    const estacao = train.currentStop?.designation || null;
    return estacao ? `Na estação (${estacao})` : "Parado na estação";
  },
  "AT_DESTINATION": (train) => `Chegou ao destino: ${train.destination?.designation || '---'}`,
  "CANCELLED": () => "Cancelado",
  "UNKNOWN": () => "Estado desconhecido"
};

    function atualizarComboios() {
      fetch("https://cp-iota-ten.vercel.app/api/comboios")
        .then(res => res.json())
        .then(data => {
          markers.forEach(m => map.removeLayer(m));
          markers = [];

          const comboios = Array.isArray(data) ? data : data.vehicles || data.data || [];

          comboios.forEach(train => {
            if (train.latitude && train.longitude) {
              const tipoOriginal = train.service?.designation || "default";
              const tipoNormalizado = tipoOriginal.trim().toLowerCase();
              const cor = cores[tipoNormalizado] || cores["default"];
              const icon = criarIcone(cor);
              const horaAtual = new Date().toLocaleTimeString("pt-PT", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
              const estadoLegivel = estadosLegiveis[train.status]?.(train) || train.status || '---';

              const marker = L.marker([train.latitude, train.longitude], { icon }).addTo(map);
              marker.bindPopup(`
                <div style="font-family:Arial, sans-serif; font-size:13px; line-height:1.6; max-width:250px;">
                  <div style="background:#FF9800; color:#000; padding:4px 6px; border-radius:4px; display:inline-block; margin-bottom:6px;">
                    <strong>Comboio:</strong> ${train.trainNumber || '---'}
                  </div>
                  <div style="background:${cor}; color:#000; padding:4px 6px; border-radius:4px; display:inline-block; margin-bottom:6px;">
                    <strong>Serviço:</strong> ${train.service?.designation || '---'}
                  </div>
                  <div><strong>Origem:</strong> ${train.origin?.designation || '---'}</div>
                  <div><strong>Destino:</strong> ${train.destination?.designation || '---'}</div>
                  <div><strong>Velocidade:</strong> ${train.speed != null ? train.speed + ' km/h' : '---'}</div>
                  <div><strong>Atraso:</strong> ${train.delay != null ? train.delay + ' s' : '---'}</div>
                  <div><strong>Estado:</strong> ${estadoLegivel}</div>
                  <div style="font-size:11px; color:#999; text-align:right; margin-top:6px;">
                    Atualizado às ${horaAtual}
                  </div>
                </div>
              `);
              markers.push(marker);
            }
          });
        })
        .catch(err => console.error("Erro ao buscar dados:", err));
    }

    atualizarComboios();
    setInterval(atualizarComboios, 30000);
  </script>
</body>
</html>
